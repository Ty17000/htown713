<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Wish List – with Accounts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root{
        --primary:#500000;--secondary:#000000;--accent:#000000;
        --light:#f8f9fa;--dark:#212529;--gray:#6c757d;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
        font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
        background:linear-gradient(135deg,#500000 30%,#fff 100%);
        min-height:100vh;color:var(--dark);
    }
    header{
        background:var(--primary);color:#fff;position:relative;
        text-align:center;padding:2rem 1rem;box-shadow:0 4px 6px rgba(0,0,0,.1);
    }
    h1{font-size:2.5rem;margin-bottom:.5rem;text-shadow:1px 1px 3px rgba(0,0,0,.2);}
    .subtitle{font-size:1.1rem;opacity:.9;}
    .account-menu{
        position:absolute;right:1rem;top:1rem;
    }
    .account-menu button{
        background:none;border:none;color:#fff;font-size:1rem;cursor:pointer;
    }
    .account-menu .dropdown{
        display:none;position:absolute;right:0;background:#fff;
        box-shadow:0 4px 12px rgba(0,0,0,.15);border-radius:8px;
        min-width:150px;padding:.5rem 0;
    }
    .account-menu:hover .dropdown{display:block;}
    .account-menu .dropdown button{
        display:block;width:100%;text-align:left;padding:.5rem 1rem;
        background:none;border:none;color:var(--dark);cursor:pointer;
    }
    .account-menu .dropdown button:hover{background:#f1f1f1;}

    .container{max-width:900px;margin:2rem auto;padding:0 1rem;}
    .input-section,.save-section,.auth-modal{
        background:#fff;padding:1.5rem;border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:2rem;
    }
    .form-group{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem;}
    input[type=text],input[type=url],input[type=number],input[type=email],
    input[type=password],select{
        flex:1;min-width:200px;padding:.75rem;border:2px solid #dee2e6;
        border-radius:8px;font-size:1rem;transition:border .3s;
    }
    input:focus,select:focus{outline:none;border-color:var(--primary);}
    button{
        background:var(--primary);color:#fff;border:none;padding:.75rem 1.5rem;
        border-radius:8px;font-size:1rem;cursor:pointer;transition:all .3s;
        font-weight:600;
    }
    button:hover{background:var(--secondary);transform:translateY(-2px);}
    .wishlist{display:grid;gap:1.5rem;}
    .wishlist-item{background:#fff;border-radius:12px;overflow:hidden;
        box-shadow:0 4px 12px rgba(0,0,0,.1);transition:transform .3s,box-shadow .3s;
        display:flex;flex-direction:column;
    }
    .wishlist-item:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,.15);}
    .item-image{width:100%;height:200px;object-fit:cover;background:#eee;
        border-bottom:3px solid var(--accent);}
    .item-content{padding:1.25rem;flex-grow:1;display:flex;flex-direction:column;}
    .item-title{font-size:1.3rem;font-weight:600;margin-bottom:.5rem;color:var(--secondary);}
    .item-price{font-weight:600;color:var(--primary);margin-bottom:.5rem;}
    .item-link{color:var(--primary);text-decoration:none;font-weight:500;
        margin-bottom:1rem;word-break:break-all;}
    .item-link:hover{text-decoration:underline;}
    .item-actions{display:flex;gap:.5rem;margin-top:auto;}
    .btn-small{padding:.5rem 1rem;font-size:.9rem;flex:1;}
    .btn-edit{background:var(--secondary);}
    .btn-edit:hover{background:#2a1b8a;}
    .btn-delete{background:#dc3545;}
    .btn-delete:hover{background:#c82333;}
    .empty-state{text-align:center;padding:3rem;color:#6c757d;font-size:1.1rem;}
    .total-price{background:#fff;padding:1.5rem;border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,.1);text-align:center;
        font-size:1.3rem;font-weight:600;color:var(--primary);}
    .share-section{background:#fff;padding:1.5rem;border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,.1);margin-top:1rem;text-align:center;}
    .share-buttons{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:1rem;}
    .share-btn{flex:1;min-width:120px;padding:.75rem;font-size:.95rem;
        border-radius:8px;cursor:pointer;transition:all .3s;font-weight:600;}
    .btn-copy{background:var(--gray);}
    .btn-copy:hover{background:#5a6268;}
    .btn-sms{background:#500000;}
    .btn-sms:hover{background:#fff;color:#500000;}
    .btn-email{background:#000;}
    .btn-email:hover{background:#fff;color:#000;}
    .btn-update{background:#500000;}
    .btn-update:hover{background:#5a6268;}
    .saved-lists{margin-top:.5rem;}
    .saved-list-item{display:flex;gap:.5rem;align-items:center;background:#f8f9fa;
        padding:.4rem .8rem;border-radius:6px;margin-bottom:.3rem;font-size:.95rem;}
    .saved-list-item button{
        background:#fff;color:#500000;border:none;padding:.2rem .5rem;
        border-radius:4px;font-size:.8rem;cursor:pointer;
    }
    .saved-list-item button:hover{background:#000;color:#fff;}
    .update-notice{font-size:.9rem;color:#500000;margin:.5rem 0;}
    footer{text-align:center;padding:2rem;color:#fff;font-size:.9rem;margin-top:3rem;}

    /* Modal */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);
        align-items:center;justify-content:center;z-index:999;}
    .modal-backdrop.show{display:flex;}
    .auth-modal{max-width:380px;width:90%;text-align:center;}
    .auth-modal h2{margin-bottom:1rem;}
    .auth-modal .form-group{flex-direction:column;}
    .auth-modal button{margin-top:1rem;width:100%;}
    .auth-modal .toggle-link{margin-top:1rem;font-size:.9rem;color:var(--primary);cursor:pointer;}
    @media(max-width:768px){
        .form-group{flex-direction:column;}
        input[type=text],input[type=url],input[type=number],
        input[type=email],input[type=password],select{min-width:100%;}
        h1{font-size:2rem;}
        .share-buttons{flex-direction:column;}
        .share-btn{min-width:100%;}
    }
</style>
</head>
<body>

<header>
    <h1>My Wish List</h1>
    <p class="subtitle">Create, save, update, and share your dream list</p>

    <div class="account-menu" id="accountMenu" style="display:none;">
        <button id="accountBtn">Account</button>
        <div class="dropdown">
            <button id="logoutBtn">Logout</button>
        </div>
    </div>
</header>

<div class="container">

    <!-- SAVE / LOAD -->
    <div class="save-section" id="saveSection" style="display:none;">
        <h3>Save / Load List</h3>
        <div class="form-group">
            <input type="text" id="listName" placeholder="List name (e.g., Birthday 2026)">
            <button onclick="saveCurrentList()">Save List</button>
        </div>
        <div id="savedListsContainer" class="saved-lists"></div>
    </div>

    <!-- ADD ITEM -->
    <div class="input-section" id="addSection" style="display:none;">
        <h2>Add an Item</h2>
        <div class="form-group">
            <input type="text" id="itemName" placeholder="Item name (e.g., Wireless Earbuds)">
            <input type="url" id="itemLink" placeholder="Link to item (optional)">
        </div>
        <div class="form-group">
            <input type="text" id="itemImage" placeholder="Image URL (optional)">
            <input type="number" id="itemPrice" placeholder="Price ($)" step="0.01">
        </div>
        <button onclick="addItem()">Add to List</button>
    </div>

    <div id="totalPrice" class="total-price" style="display:none;">
        Total Estimated Cost: $<span id="totalAmount">0.00</span>
    </div>

    <div id="wishlist" class="wishlist">
        <div class="empty-state">
            <div style="font-size:4rem;margin-bottom:1rem;">Gift</div>
            <p>Your wish list is empty. Add your first item above!</p>
        </div>
    </div>

    <!-- SHARE -->
    <div class="share-section" id="shareSection" style="display:none;">
        <h3>Share Your List</h3>
        <p>Send via email, text, or copy the link:</p>
        <p id="shareLink" style="font-weight:600;word-break:break-all;margin:1rem 0;font-size:.9rem;"></p>
        <div id="updateNotice" class="update-notice" style="display:none;">
            List updated! Use the new link below to share changes.
        </div>
        <div class="share-buttons">
            <button class="share-btn btn-copy" onclick="copyShareLink()">Copy Link</button>
            <button class="share-btn btn-sms" onclick="shareViaSMS()">Send SMS</button>
            <button class="share-btn btn-email" onclick="shareViaEmail()">Send Email</button>
            <button id="updateBtn" class="share-btn btn-update" onclick="copyUpdatedLink()" style="display:none;">
                Copy Updated Link
            </button>
        </div>
    </div>
</div>

<footer><p>Made with love for any occasion</p></footer>

<!-- AUTH MODAL -->
<div class="modal-backdrop" id="authModal">
    <div class="auth-modal">
        <h2 id="modalTitle">Login</h2>
        <div class="form-group">
            <input type="email" id="authEmail" placeholder="Email">
        </div>
        <div class="form-group">
            <input type="text" id="authPass" placeholder="Password">
        </div>
        <button id="authSubmit">Login</button>
        <p class="toggle-link" id="toggleLink">Need an account? <span style="text-decoration:underline;">Register</span></p>
    </div>
</div>

<script>
/* ====================  INDEXEDDB SETUP  ==================== */
const DB_NAME = 'WishListDB';
const STORE_USERS = 'users';
const STORE_LISTS = 'lists';
let db;

/* Open DB */
const openReq = indexedDB.open(DB_NAME, 2);
openReq.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains(STORE_USERS)) {
        const users = db.createObjectStore(STORE_USERS, {keyPath:'id', autoIncrement:true});
        users.createIndex('email','email',{unique:true});
    }
    if (!db.objectStoreNames.contains(STORE_LISTS)) {
        const lists = db.createObjectStore(STORE_LISTS, {keyPath:'id', autoIncrement:true});
        lists.createIndex('userId','userId');
    }
};
openReq.onsuccess = e => { db = e.target.result; initApp(); };
openReq.onerror = e => console.error('DB error', e);

/* ====================  AUTH HELPERS  ==================== */
const SESSION_KEY = 'wishlist-session';
let currentUser = null;   // {id, email}

async function hashPassword(pw, salt = crypto.randomUUID()) {
    const encoder = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
        'raw', encoder.encode(pw), 'PBKDF2', false, ['deriveBits']
    );
    const derived = await crypto.subtle.deriveBits(
        {name:'PBKDF2', salt:encoder.encode(salt), iterations:200000, hash:'SHA-256'},
        keyMaterial, 256
    );
    return {hash: btoa(String.fromCharCode(...new Uint8Array(derived))), salt};
}

/* Register */
async function register(email, pw) {
    const {hash, salt} = await hashPassword(pw);
    return new Promise((res,rej)=>{
        const tx = db.transaction(STORE_USERS,'readwrite');
        const store = tx.objectStore(STORE_USERS);
        const req = store.add({email, hash, salt});
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
    });
}

/* Login */
async function login(email, pw) {
    return new Promise((res,rej)=>{
        const tx = db.transaction(STORE_USERS,'readonly');
        const idx = tx.objectStore(STORE_USERS).index('email');
        const req = idx.get(email);
        req.onsuccess = async () => {
            const user = req.result;
            if (!user) return rej('User not found');
            const {hash} = await hashPassword(pw, user.salt);
            if (hash !== user.hash) return rej('Wrong password');
            res(user);
        };
        req.onerror = () => rej(req.error);
    });
}

/* ====================  APP STATE  ==================== */
let wishlist = [];
const TEMP_KEY = 'temp-wishlist';
let isSharedList = false;
let originalSharedData = null;

/* Init after DB ready */
function initApp() {
    // Restore session
    const sess = localStorage.getItem(SESSION_KEY);
    if (sess) {
        try { currentUser = JSON.parse(sess); } catch(e){}
    }

    // UI according to login state
    updateAuthUI();

    // Load temp list (if any)
    const saved = localStorage.getItem(TEMP_KEY);
    if (saved) wishlist = JSON.parse(saved);

    // Check for shared list in URL
    const params = new URLSearchParams(location.search);
    const shared = params.get('list');
    if (shared && wishlist.length===0) {
        try {
            const decoded = JSON.parse(atob(shared));
            if (Array.isArray(decoded)) {
                wishlist = decoded;
                isSharedList = true;
                originalSharedData = JSON.stringify(decoded);
                saveTemp();
            }
        } catch(e){ console.error('Invalid share'); }
    }

    renderWishlist();
    if (currentUser) loadSavedListNames();
}

/* Update header / sections when login state changes */
function updateAuthUI() {
    const loggedIn = !!currentUser;
    document.getElementById('accountMenu').style.display = loggedIn ? 'block' : 'none';
    document.getElementById('saveSection').style.display = loggedIn ? 'block' : 'none';
    document.getElementById('addSection').style.display = loggedIn ? 'block' : 'none';

    if (!loggedIn) {
        document.getElementById('authModal').classList.add('show');
    } else {
        document.getElementById('authModal').classList.remove('show');
    }
}

/* ====================  MODAL HANDLERS  ==================== */
const modal = document.getElementById('authModal');
const title = document.getElementById('modalTitle');
const submitBtn = document.getElementById('authSubmit');
const toggleLink = document.getElementById('toggleLink');
let isRegister = false;

toggleLink.onclick = () => {
    isRegister = !isRegister;
    title.textContent = isRegister ? 'Register' : 'Login';
    submitBtn.textContent = isRegister ? 'Register' : 'Login';
    toggleLink.innerHTML = isRegister ?
        `Already have an account? <span style="text-decoration:underline;">Login</span>` :
        `Need an account? <span style="text-decoration:underline;">Register</span>`;
};

submitBtn.onclick = async () => {
    const email = document.getElementById('authEmail').value.trim();
    const pw    = document.getElementById('authPass').value;
    if (!email || !pw) return alert('Fill both fields');

    try {
        if (isRegister) {
            await register(email, pw);
            alert('Registered! Now log in.');
            toggleLink.click(); // switch to login
        } else {
            const user = await login(email, pw);
            currentUser = {id:user.id, email:user.email};
            localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
            updateAuthUI();
            loadSavedListNames();
        }
    } catch (e) {
        alert(e);
    }
};

document.getElementById('logoutBtn').onclick = () => {
    if (!confirm('Log out?')) return;
    currentUser = null;
    localStorage.removeItem(SESSION_KEY);
    localStorage.removeItem(TEMP_KEY);
    wishlist = [];
    updateAuthUI();
    renderWishlist();
};

/* ====================  ITEM CRUD (unchanged logic) ==================== */
function addItem() {
    const name = document.getElementById('itemName').value.trim();
    const link = document.getElementById('itemLink').value.trim();
    const image = document.getElementById('itemImage').value.trim();
    const price = parseFloat(document.getElementById('itemPrice').value) || 0;
    if (!name) return alert('Item name required!');

    wishlist.push({id:Date.now(), name, link:link||null, image:image||null, price});
    saveTemp();
    markAsChanged();
    renderWishlist();
    clearForm();
}
function clearForm(){
    ['itemName','itemLink','itemImage','itemPrice'].forEach(id=>document.getElementById(id).value='');
}
function deleteItem(id){
    wishlist = wishlist.filter(i=>i.id!==id);
    saveTemp(); markAsChanged(); renderWishlist();
}
function editItem(id){
    const it = wishlist.find(i=>i.id===id);
    if(!it) return;
    document.getElementById('itemName').value = it.name;
    document.getElementById('itemLink').value = it.link||'';
    document.getElementById('itemImage').value = it.image||'';
    document.getElementById('itemPrice').value = it.price||'';
    deleteItem(id);
}
function saveTemp(){ localStorage.setItem(TEMP_KEY, JSON.stringify(wishlist)); }
function markAsChanged(){
    if(!isSharedList) return;
    const cur = JSON.stringify(wishlist);
    if(cur !== originalSharedData){
        document.getElementById('updateNotice').style.display='block';
        document.getElementById('updateBtn').style.display='inline-block';
    }
}

/* ====================  RENDER  ==================== */
function renderWishlist(){
    const container = document.getElementById('wishlist');
    const empty = container.querySelector('.empty-state');

    if(wishlist.length===0){
        if(!empty){
            container.innerHTML = `<div class="empty-state">
                <div style="font-size:4rem;margin-bottom:1rem;">Gift</div>
                <p>Your wish list is empty. Add your first item above!</p>
            </div>`;
        }
        hideTotalsAndShare(); return;
    }
    if(empty) empty.remove();

    const total = wishlist.reduce((s,i)=>s+i.price,0);
    document.getElementById('totalAmount').textContent = total.toFixed(2);
    document.getElementById('totalPrice').style.display='block';

    const shareUrl = `${location.origin}${location.pathname}?list=${btoa(JSON.stringify(wishlist))}`;
    document.getElementById('shareLink').textContent = shareUrl;
    document.getElementById('shareSection').style.display='block';

    container.innerHTML = wishlist.map(it=>`
        <div class="wishlist-item">
            ${it.image?
                `<img src="${it.image}" alt="${it.name}" class="item-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjOTk5Ij5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='">`
                :`<div class="item-image" style="display:flex;align-items:center;justify-content:center;background:#f0f0f0;color:#999;font-size:1.2rem;">Gift ${it.name}</div>`
            }
            <div class="item-content">
                <div class="item-title">${it.name}</div>
                ${it.price>0?`<div class="item-price">$${it.price.toFixed(2)}</div>`:''}
                ${it.link?`<a href="${it.link}" target="_blank" class="item-link">View Item</a>`:''}
                <div class="item-actions">
                    <button class="btn-small btn-edit" onclick="editItem(${it.id})">Edit</button>
                    <button class="btn-small btn-delete" onclick="deleteItem(${it.id})">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}
function hideTotalsAndShare(){
    document.getElementById('totalPrice').style.display='none';
    document.getElementById('shareSection').style.display='none';
    document.getElementById('updateNotice').style.display='none';
    document.getElementById('updateBtn').style.display='none';
}

/* ====================  SAVE / LOAD NAMED LISTS (per user) ==================== */
function saveCurrentList(){
    const name = document.getElementById('listName').value.trim();
    if(!name){ alert('Enter a list name!'); return; }
    if(wishlist.length===0){ alert('List is empty!'); return; }

    const tx = db.transaction(STORE_LISTS,'readwrite');
    const store = tx.objectStore(STORE_LISTS);
    store.add({userId:currentUser.id, name, items:JSON.parse(JSON.stringify(wishlist)), created:new Date()});
    tx.oncomplete = ()=>{ alert(`"${name}" saved!`); document.getElementById('listName').value=''; loadSavedListNames(); };
    tx.onerror = ()=>{ alert('Save error'); };
}

function loadSavedListNames(){
    const container = document.getElementById('savedListsContainer');
    container.innerHTML = '<strong>Saved lists:</strong>';
    const tx = db.transaction(STORE_LISTS,'readonly');
    const idx = tx.objectStore(STORE_LISTS).index('userId');
    const req = idx.openCursor(IDBKeyRange.only(currentUser.id));
    const list = [];
    req.onsuccess = e=>{
        const cursor = e.target.result;
        if(cursor){
            list.push({id:cursor.value.id, name:cursor.value.name});
            cursor.continue();
        }else{
            if(list.length===0){
                container.innerHTML += '<p style="margin-top:.5rem;color:#777;">No saved lists yet.</p>';
            }else{
                list.forEach(l=>{
                    const div = document.createElement('div');
                    div.className='saved-list-item';
                    div.innerHTML = `
                        <span>${l.name}</span>
                        <button onclick="loadListById(${l.id})">Load</button>
                        <button onclick="deleteListById(${l.id})">Delete</button>
                    `;
                    container.appendChild(div);
                });
            }
        }
    };
}

function loadListById(id){
    const tx = db.transaction(STORE_LISTS,'readonly');
    const store = tx.objectStore(STORE_LISTS);
    const req = store.get(id);
    req.onsuccess = e=>{
        const data = e.target.result;
        if(data && data.userId===currentUser.id){
            wishlist = data.items;
            isSharedList = false;
            originalSharedData = null;
            saveTemp();
            renderWishlist();
            alert(`Loaded "${data.name}"`);
        }
    };
}
function deleteListById(id){
    if(!confirm('Delete this saved list?')) return;
    const tx = db.transaction(STORE_LISTS,'readwrite');
    const store = tx.objectStore(STORE_LISTS);
    store.delete(id);
    tx.oncomplete = ()=>{ loadSavedListNames(); };
}

/* ====================  SHARING (unchanged) ==================== */
function copyShareLink(){
    const link = document.getElementById('shareLink').textContent;
    navigator.clipboard.writeText(link).then(()=>{
        const btn = event.target;
        const orig = btn.textContent;
        btn.textContent='Copied!';
        setTimeout(()=>btn.textContent=orig,2000);
    });
}
function copyUpdatedLink(){ copyShareLink(); }
function shareViaSMS(){
    const link = document.getElementById('shareLink').textContent;
    const msg = `Check out my wish list!\n${link}`;
    window.open(`sms:?body=${encodeURIComponent(msg)}`,'_blank');
}
function shareViaEmail(){
    const link = document.getElementById('shareLink').textContent;
    const subject = "My Wish List";
    const body = `Hi!\n\nHere’s my current wish list:\n${link}\n\nLet me know if you need ideas!\n`;
    window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,'_blank');
}

/* Enter key adds item */
document.addEventListener('keypress', e=>{
    if(e.key==='Enter' && e.target.tagName==='INPUT' && currentUser) addItem();
});
</script>
</body>
</html>